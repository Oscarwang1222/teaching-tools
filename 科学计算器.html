<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <script defer src="https://cloud.umami.is/script.js"
        data-website-id="d6ee6da5-3779-4551-a754-7f63fdf95dbb"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÁßëÂ≠¶ËÆ°ÁÆóÂô®</title>
    <style>
        :root {
            --primary-color: #2A5CAA;
            --secondary-color: #00E5FF;
            --accent-color: #6A00FF;
            --light-color: #010409;
            --dark-color: #ffffff;
            --success-color: #28a745;
            --card-bg: #0d1117;
            --card-border: 1px solid #30363d;
            --card-shadow: 0 10px 20px rgba(0, 0, 0, 0.5);
            --transition: all 0.3s ease;

            /* Mapped Variables */
            --bg-color: var(--light-color);
            --panel-color: var(--card-bg);
            --text-color: var(--dark-color);
            --button-bg: #161b22;
            --button-border: #30363d;
            --button-hover: #21262d;
            --button-active: #2f363d;
            --operator-color: var(--secondary-color);
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
        }

        .calculator {
            background-color: var(--panel-color);
            border-radius: 12px;
            box-shadow: var(--card-shadow);
            border: var(--card-border);
            width: 400px;
            max-width: 95vw;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* Display Area */
        .display-container {
            padding: 20px;
            background-color: rgba(0, 0, 0, 0.3);
            position: relative;
        }

        #display {
            width: 100%;
            height: 120px;
            background-color: transparent;
            border: none;
            color: var(--text-color);
            font-size: 24px;
            font-family: 'Consolas', 'Monaco', monospace;
            resize: none;
            outline: none;
            text-align: right;
            line-height: 1.5;
            padding: 0;
            padding-bottom: 30px;
            /* Space for sound button */
            box-sizing: border-box;
        }

        .sound-btn {
            position: absolute;
            bottom: 5px;
            right: 5px;
            background: none;
            border: none;
            color: #666;
            font-size: 20px;
            cursor: pointer;
            padding: 5px;
            transition: color 0.2s;
            height: auto;
            width: auto;
        }

        .sound-btn:hover {
            color: #fff;
            background-color: transparent;
        }

        .keyboard-btn {
            position: absolute;
            bottom: 5px;
            right: 40px;
            /* Positioned to the left of sound-btn */
            background: none;
            border: none;
            color: #666;
            font-size: 20px;
            cursor: pointer;
            padding: 5px;
            transition: color 0.2s;
            height: auto;
            width: auto;
        }

        .keyboard-btn:hover {
            color: #fff;
        }

        .keyboard-btn.disabled {
            color: #ff6b6b;
            /* Red when disabled */
            text-decoration: line-through;
        }

        /* Input/Keypad Area */
        .keypad {
            padding: 15px;
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
        }

        button {
            border: 1px solid var(--button-border);
            border-radius: 6px;
            height: 50px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            color: #8b949e;
            /* Muted text default */
            background-color: var(--button-bg);
            user-select: none;
        }

        button:hover {
            border-color: var(--secondary-color);
            color: var(--secondary-color);
            transform: translateY(-2px);
        }

        button:active {
            transform: scale(0.96);
        }

        /* Specific Button Styles */
        .btn-num {
            background-color: var(--button-bg);
            color: var(--text-color);
        }

        .btn-op {
            background-color: rgba(42, 92, 170, 0.1);
            /* Slight primary tint */
            color: var(--secondary-color);
            border-color: var(--primary-color);
        }

        .btn-op:hover {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-func {
            font-size: 14px;
            font-style: italic;
        }

        .btn-control {
            color: #ff6b6b;
            border-color: #ff6b6b;
        }

        .btn-control:hover {
            background-color: #ff6b6b;
            color: white;
            border-color: #ff6b6b;
        }

        .btn-equal {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border: none;
            grid-column: span 1;
        }

        .btn-equal:hover {
            opacity: 0.9;
            color: white;
            border: none;
            /* Override default hover border */
            box-shadow: 0 0 10px rgba(0, 229, 255, 0.4);
        }

        .btn-arrow {
            font-size: 20px;
        }
    </style>
</head>

<body>

    <div class="calculator">
        <div class="display-container">
            <textarea id="display" placeholder="0" spellcheck="false"></textarea>
            <button class="keyboard-btn" onclick="toggleKeyboard()" title="Á¶ÅÁî®/ÂêØÁî®ÈîÆÁõòËæìÂÖ•">‚å®Ô∏è</button>
            <button class="sound-btn" onclick="speak()" title="ÊúóËØª">üîä</button>
        </div>
        <div class="keypad">
            <!-- Row 1 -->
            <button class="btn-func" onclick="insertFunc('sin(')">sin</button>
            <button class="btn-func" onclick="insertFunc('cos(')">cos</button>
            <button class="btn-func" onclick="insertFunc('tan(')">tan</button>
            <button class="btn-control" onclick="clearDisplay()">AC</button>
            <button class="btn-control" onclick="deleteChar()">DEL</button>

            <!-- Row 2 -->
            <button class="btn-func" onclick="insertFunc('log(')">log</button>
            <button class="btn-func" onclick="insertFunc('ln(')">ln</button>
            <button class="btn-op" onclick="insert('(')">(</button>
            <button class="btn-op" onclick="insert(')')">)</button>
            <button class="btn-op" onclick="insert('^')">^</button>

            <!-- Row 3 -->
            <button class="btn-func" onclick="insertFunc('sqrt(')">‚àö</button>
            <button class="btn-num" onclick="insert('7')">7</button>
            <button class="btn-num" onclick="insert('8')">8</button>
            <button class="btn-num" onclick="insert('9')">9</button>
            <button class="btn-op" onclick="insert('/')">√∑</button>

            <!-- Row 4 -->
            <button class="btn-func" onclick="insert('PI')">œÄ</button>
            <button class="btn-num" onclick="insert('4')">4</button>
            <button class="btn-num" onclick="insert('5')">5</button>
            <button class="btn-num" onclick="insert('6')">6</button>
            <button class="btn-op" onclick="insert('*')">√ó</button>

            <!-- Row 5 -->
            <button class="btn-func" onclick="insert('E')">e</button>
            <button class="btn-num" onclick="insert('1')">1</button>
            <button class="btn-num" onclick="insert('2')">2</button>
            <button class="btn-num" onclick="insert('3')">3</button>
            <button class="btn-op" onclick="insert('-')">-</button>

            <!-- Row 6 -->
            <button class="btn-arrow" onclick="moveCursor(-1)">‚Üê</button>
            <button class="btn-arrow" onclick="moveCursor(1)">‚Üí</button>
            <button class="btn-num" onclick="insert('0')">0</button>
            <button class="btn-num" onclick="insert('.')">.</button>
            <button class="btn-op" onclick="insert('+')">+</button>

            <!-- Row 7 (Full width equal) -->
            <button class="btn-equal" style="grid-column: span 5;" onclick="calculate()">=</button>
        </div>
    </div>

    <script>
        const display = document.getElementById('display');
        let lastExpression = '';
        let lastResult = '';
        let isCalculationDone = false;
        let isKeyboardDisabled = false;

        // Focus display initially
        window.onload = () => {
            display.focus();
        };

        // Keep focus on display after button clicks (unless it's a specific interaction)
        document.querySelector('.keypad').addEventListener('mousedown', (e) => {
            if (e.target.tagName === 'BUTTON') {
                e.preventDefault(); // Prevents focus loss from text area
            }
        });

        function insert(value) {
            resetCalcState();
            const start = display.selectionStart;
            const end = display.selectionEnd;
            const text = display.value;

            display.value = text.substring(0, start) + value + text.substring(end);

            // Move cursor after inserted text
            display.selectionStart = display.selectionEnd = start + value.length;

            // Trigger auto-scroll or just focus
            display.focus();
        }

        function insertFunc(func) {
            insert(func);
        }

        function clearDisplay() {
            display.value = '';
            resetCalcState();
            display.focus();
        }

        function deleteChar() {
            resetCalcState();
            const start = display.selectionStart;
            const end = display.selectionEnd;
            const text = display.value;

            if (start === end) {
                // No selection
                if (start > 0) {
                    display.value = text.substring(0, start - 1) + text.substring(end);
                    display.selectionStart = display.selectionEnd = start - 1;
                }
            } else {
                // Selection exists
                display.value = text.substring(0, start) + text.substring(end);
                display.selectionStart = display.selectionEnd = start;
            }
            display.focus();
        }

        function moveCursor(direction) {
            const start = display.selectionStart;
            const end = display.selectionEnd;

            if (start !== end) {
                // If text is selected, collapse to left or right depending on direction
                if (direction < 0) display.selectionStart = display.selectionEnd = start;
                else display.selectionStart = display.selectionEnd = end;
            } else {
                const newPos = start + direction;
                if (newPos >= 0 && newPos <= display.value.length) {
                    display.selectionStart = display.selectionEnd = newPos;
                }
            }
            display.focus();
        }

        function calculate() {
            // Get all lines
            let lines = display.value.split('\n');
            let lastLine = '';

            // Find the last non-empty line to evaluate
            for (let i = lines.length - 1; i >= 0; i--) {
                if (lines[i].trim() !== '') {
                    lastLine = lines[i];
                    break;
                }
            }

            if (!lastLine) return;

            // Strip leading '=' or whitespace if user is chaining e.g. "= 5" + "+ 2"
            let expression = lastLine.replace(/^\s*=\s*/, '');

            if (!expression) return;

            // Store original expression for reading
            lastExpression = expression;

            // Replace UI symbols with JS Math equivalent
            let evalExpr = expression
                .replace(/√ó/g, '*')
                .replace(/√∑/g, '/')
                .replace(/\^/g, '**')
                .replace(/œÄ/g, 'Math.PI')
                .replace(/PI/g, 'Math.PI') // Just in case
                .replace(/\bE\b/g, 'Math.E')
                .replace(/sin\(/g, 'Math.sin(')
                .replace(/cos\(/g, 'Math.cos(')
                .replace(/tan\(/g, 'Math.tan(')
                .replace(/log\(/g, 'Math.log10(')
                .replace(/ln\(/g, 'Math.log(')
                .replace(/sqrt\(/g, 'Math.sqrt(');

            try {
                // Safer evaluation than raw eval, though still Function
                const result = new Function('return ' + evalExpr)();

                // Format result
                let resultStr = result.toString();
                if (resultStr.length > 15) {
                    resultStr = parseFloat(result.toFixed(10)).toString(); // Remove trailing zeros
                }

                // Append result on new line
                display.value += '\n= ' + resultStr;
                display.scrollTop = display.scrollHeight; // Auto scroll to bottom

                lastResult = resultStr;
                isCalculationDone = true;

            } catch (e) {
                // flash error
                const oldColor = display.style.color;
                display.style.color = '#ff6b6b';
                setTimeout(() => {
                    display.style.color = oldColor;
                }, 500);

                isCalculationDone = false;
            }
            display.focus();
        }

        function speak() {
            let textToRead = '';

            // Check if we just calculated something and currently showing it (or history)
            if (isCalculationDone) {
                // Read specifically the last operation
                textToRead = lastExpression + " Á≠â‰∫é " + lastResult;
            } else {
                // Otherwise read the current line? Or all text?
                const start = display.selectionStart;
                const text = display.value;

                if (!text.trim()) return;

                // Heuristic: if text contains newline, read the last non-empty line
                if (text.includes('\n')) {
                    let lines = text.split('\n');
                    for (let i = lines.length - 1; i >= 0; i--) {
                        if (lines[i].trim()) {
                            textToRead = lines[i];
                            break;
                        }
                    }
                } else {
                    textToRead = text;
                }
            }

            // Format for natural reading (Chinese)
            textToRead = textToRead
                .replace(/\+/g, 'Âä†')
                .replace(/\-/g, 'Âáè')
                .replace(/\*/g, '‰πò')
                .replace(/√ó/g, '‰πò')
                .replace(/\//g, 'Èô§')
                .replace(/√∑/g, 'Èô§')
                .replace(/\^/g, 'ÁöÑÊ¨°Êñπ')
                .replace(/\./g, 'ÁÇπ')
                .replace(/=/g, 'Á≠â‰∫é')
                .replace(/\(/g, '') // Parens can be awkward
                .replace(/\)/g, '')
                .replace(/sin/g, 'Ê≠£Âº¶')
                .replace(/cos/g, '‰ΩôÂº¶')
                .replace(/tan/g, 'Ê≠£Âàá')
                .replace(/sqrt/g, 'Ê†πÂè∑')
                .replace(/log/g, 'ÂØπÊï∞')
                .replace(/ln/g, 'Ëá™ÁÑ∂ÂØπÊï∞');

            const utterance = new SpeechSynthesisUtterance(textToRead);
            utterance.lang = 'zh-CN'; // Set language to Chinese
            window.speechSynthesis.cancel(); // Stop previous
            window.speechSynthesis.speak(utterance);

            display.focus();
        }

        // Reset flags on input
        function resetCalcState() {
            isCalculationDone = false;
        }

        display.addEventListener('input', (e) => {
            // Although we try to preventDefault on keydown, 'input' can still happen via other means
            // or if prevention fails.  Strictly ensuring no changes if disabled could be done here:
            // if (isKeyboardDisabled) { display.value = ...; } 

            resetCalcState();
        });

        // Keyboard support logic
        display.addEventListener('keydown', (e) => {
            // Block normal typing if disabled
            if (isKeyboardDisabled) {
                // Allow navigation keys
                const allowedKeys = ['ArrowLeft', 'ArrowRight', 'ArrowUp', 'ArrowDown', 'Home', 'End', 'PageUp', 'PageDown'];

                // Allow shortcuts like Ctrl+C (copy) - often good UX even if disabled
                if (e.ctrlKey || e.metaKey) return;

                if (!allowedKeys.includes(e.key)) {
                    e.preventDefault();
                    // Don't return here if we want to handle visual feedback, but usually just blocking is enough
                    return;
                }
            }

            if (e.key === 'Enter') {
                e.preventDefault();
                calculate();
            } else if (e.key === 'Escape') {
                clearDisplay();
            }
            // Allow arrows and standard input
        });

        // Toggle Keyboard Input
        function toggleKeyboard() {
            const btn = document.querySelector('.keyboard-btn');
            isKeyboardDisabled = !isKeyboardDisabled;

            if (!isKeyboardDisabled) {
                // Enable keyboard
                btn.classList.remove('disabled');
                btn.title = "Á¶ÅÁî®ÈîÆÁõòËæìÂÖ•";
            } else {
                // Disable keyboard
                // We rely solely on JS keydown blocking to disable input.
                // We do NOT set readonly or inputmode=none, as that hides the cursor on some systems.
                btn.classList.add('disabled');
                btn.title = "ÂêØÁî®ÈîÆÁõòËæìÂÖ•";
            }
            // Always keep focus to show cursor
            display.focus();
        }
    </script>

</body>

</html>